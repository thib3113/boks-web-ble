<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boks Debug Wizard</title>
    <link rel="manifest" href="manifest.json">

    <!-- Favicons for various browsers and devices -->
    <link rel="icon" type="image/png" sizes="16x16" href="icon-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="icon-48.png">
    <link rel="icon" type="image/png" sizes="128x128" href="icon-128.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon.png">

    <!-- Apple Touch Icon (for iOS devices) -->
    <link rel="apple-touch-icon" href="icon.png">

    <meta name="theme-color" content="#1a73e8">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #1a73e8;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .step-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #1a73e8;
        }

        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        button:hover {
            background-color: #1557b0;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #e8f0fe;
            color: #1a73e8;
        }

        .status-message.error {
            background-color: #fdecea;
            color: #d93025;
        }

        .status-message.success {
            background-color: #e6f4ea;
            color: #1e8e3e;
        }

        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .info-label {
            font-weight: bold;
        }

        .log-container {
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 10px;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div id="webBluetoothWarning" style="display:none; padding: 10px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px; margin-bottom: 15px; text-align: center; font-weight: bold;">
        <!-- Message will be inserted here by JavaScript -->
    </div>
    <div class="container">
        <h1>Assistant de Débogage Boks</h1>

        <!-- Step 1: Connection & Device Info -->
        <div id="step1" class="card step active">
            <div class="step-header">
                <span class="step-title">Étape 1 : Connexion & Infos Appareil</span>
                <span>1/3</span>
            </div>
            <p>Veuillez vous rapprocher de votre Boks et cliquer sur "Connecter".</p>

            <div class="input-group" style="margin-bottom: 15px;">
                <label for="boksType" style="display:block; margin-bottom:5px; font-weight:bold;">Type de Boks :</label>
                <select id="boksType" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; width: 100%;">
                    <option value="s">ONE/S (Standard)</option>
                    <option value="m">Pro Medium</option>
                    <option value="l">Pro Large</option>
                    <option value="xl">Pro ExtraLarge</option>
                </select>
            </div>

            <button id="connectBtn">Connecter</button>
            <div id="connectionStatus" class="status-message" style="display:none;"></div>

            <div id="deviceInfoResults" style="display:none;">
                <h3>Informations Appareil</h3>
                <div class="info-grid" id="deviceInfoGrid">
                    <!-- Populated by JS -->
                </div>
                <div id="deviceInfoCheck" class="status-message" style="display:none;"></div>

                <div id="extraDataResults" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
                    <h4>Données Supplémentaires</h4>
                    <div class="info-grid" id="extraDataGrid"></div>
                </div>

                <div id="conditionalQuestions" style="margin-top: 20px; display:none;">
                    <h4>Questions de Vérification</h4>
                    <div id="questionsContainer"></div>
                </div>
            </div>

            <div class="nav-buttons">
                <button disabled>Précédent</button>
                <button id="nextStep1" disabled>Suivant</button>
            </div>
        </div>

        <!-- Step 2: Open/Close & Battery -->
        <div id="step2" class="card step">
            <div class="step-header">
                <span class="step-title">Étape 2 : Ouverture/Fermeture & Batterie</span>
                <span>2/3</span>
            </div>

            <div class="section">
                <h3>Test d'Ouverture</h3>
                <p>Entrez un code valide pour ouvrir la porte.</p>
                <input type="text" id="openCode" placeholder="Code à 6 chiffres (ex: 1234AB)" maxlength="6">
                <button id="openDoorBtn">Ouvrir la Porte</button>
                <div id="doorStatus" class="status-message" style="display:none;"></div>
            </div>

            <div class="section" style="margin-top: 20px;">
                <h3>État de la Batterie</h3>

                <div id="batteryAnalysisContainer" style="margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: #fafafa; display:none;">
                    <h4 style="margin-top:0; margin-bottom:10px;">Diagnostic Alimentation</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <div style="font-size: 0.8em; color: #666;">Déclaré / Attendu</div>
                            <div id="batUserClaim" style="font-weight: bold;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8em; color: #666;">Détecté (Voltage)</div>
                            <div id="batDetected" style="font-weight: bold;">-</div>
                        </div>
                    </div>
                    <div id="batConsistency" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; font-weight: 500;">
                        <!-- Status message will go here -->
                    </div>
                </div>

                <div id="batteryStatus" class="status-message" style="display:none;"></div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <h4>Service Standard (0x180F)</h4>
                        <div id="standardBatteryResult" class="log-container" style="display:none; height: 100px;"></div>
                    </div>
                    <div>
                        <h4>Service Propriétaire (0x0004)</h4>
                        <div id="batteryResult" class="log-container" style="display:none; height: 100px;"></div>
                    </div>
                </div>
            </div>

            <div class="nav-buttons">
                <button id="prevStep2">Précédent</button>
                <button id="nextStep2">Suivant</button>
            </div>
        </div>

        <!-- Step 3: Advanced Debug -->
        <div id="step3" class="card step">
            <div class="step-header">
                <span class="step-title">Étape 3 : Débogage Avancé (Optionnel)</span>
                <span>3/3</span>
            </div>

            <div style="background-color: #e8f0fe; padding: 15px; border-radius: 4px; border: 1px solid #d2e3fc; margin-bottom: 20px;">
                <p style="margin-top:0; font-weight: bold;">Cette étape est réservée aux utilisateurs avancés.</p>
                <p style="margin-bottom:0;">Elle permet d'utiliser des outils externes pour analyser les services Bluetooth en profondeur. Si vous ne savez pas ce qu'est un UUID ou nRF Connect, vous pouvez passer cette étape sans problème.</p>
            </div>

            <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                <button id="skipStep3Btn" style="background-color: #1e8e3e; font-size: 1.1em; padding: 12px 24px;">Passer cette étape (Recommandé)</button>
            </div>

            <div style="text-align: center;">
                <button id="showAdvancedBtn" style="background-color: #f1f3f4; color: #333; border: 1px solid #ddd;">Afficher les outils avancés</button>
            </div>

            <div id="advancedToolsContainer" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                <h3>Utilisation de nRF Connect</h3>
                <p>Pour aller plus loin, nous vous recommandons d'utiliser l'application <strong>nRF Connect for Mobile</strong>.</p>

                <ul>
                    <li><a href="https://play.google.com/store/apps/details?id=no.nordicsemi.android.mcp" target="_blank">Android (Google Play)</a></li>
                    <li><a href="https://apps.apple.com/us/app/nrf-connect-for-mobile/id1054362403" target="_blank">iOS (App Store)</a></li>
                </ul>

                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <h4 style="margin-top:0;">Tutoriel : Lister les caractéristiques</h4>
                    <ol style="padding-left: 20px;">
                        <li>Ouvrez l'application <strong>nRF Connect</strong> sur votre téléphone.</li>
                        <li>Lancez un <strong>SCAN</strong> et trouvez votre appareil "BOKS".</li>
                        <li>Cliquez sur <strong>CONNECT</strong>.</li>
                        <li>Une fois connecté, vous verrez la liste des Services (ex: <code>Generic Access</code>, <code>Battery Service</code>...).</li>
                        <li>Cherchez le service inconnu/propriétaire (souvent en bas, UUID commençant par <code>a763...</code>).</li>
                        <li>Cliquez dessus pour voir les <strong>Caractéristiques</strong> (Characteristics).</li>
                        <li>Prenez des captures d'écran des UUIDs et des valeurs (bouton flèche "Read" ↓).</li>
                    </ol>
                </div>

                <h3>Exploration Web (Expérimental)</h3>
                <p>Vous pouvez aussi explorer manuellement les services depuis cette page.</p>

                <div class="input-group">
                    <label>UUID du Service :</label>
                    <input type="text" id="customServiceUuid" placeholder="ex: 0000180f-0000-1000-8000-00805f9b34fb" list="knownServices">
                    <datalist id="knownServices">
                        <option value="a7630001-f491-4f21-95ea-846ba586e361">Boks Main Service</option>
                        <option value="0000180f-0000-1000-8000-00805f9b34fb">Battery Service</option>
                        <option value="0000180a-0000-1000-8000-00805f9b34fb">Device Info Service</option>
                    </datalist>
                    <button id="exploreServiceBtn">Explorer le Service</button>
                </div>

                <div id="serviceExplorationLog" class="log-container"></div>
            </div>

            <div class="nav-buttons">
                <button id="prevStep3">Précédent</button>
                <button id="finishBtn">Suivant (Récapitulatif)</button>
            </div>
        </div>

        <!-- Step 4: Recap -->
        <div id="step4" class="card step">
            <div class="step-header">
                <span class="step-title">Étape 4 : Récapitulatif</span>
                <span>4/4</span>
            </div>

            <p>Voici le résumé des données collectées. Copiez ce JSON pour le partager avec le support.</p>
            <p><em>Note : Aucune donnée sensible (codes PIN, clés) n'est incluse.</em></p>

            <textarea id="jsonRecap" style="width: 100%; height: 300px; font-family: monospace; margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" readonly></textarea>

            <div class="nav-buttons">
                <button id="prevStep4">Précédent</button>
                <button id="copyJsonBtn">Copier le JSON</button>
            </div>
        </div>

    </div>
    <script src="ble-utils.js"></script>
    <script src="debug.js"></script>
</body>
</html>
